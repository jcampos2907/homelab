{{- /*
Standalone Deployment for ghcr.io/lovelaze/nebula-sync:latest.

Init sequence:
1) wait-for-pihole-dns     — uses UDP via nslookup against <fullname>-dns
2) wait-for-pihole-web     — (optional) TCP:80 check against <fullname>-web-primary
3) wait-for-replicas       — parses /run/secrets/replicas and waits for EACH host:port

Override via values:
nebulaSync:
  wait:
    waitForDNS: true
    waitForWeb: false
    waitForReplicas: true
    dnsHost: ""            # e.g. "custom-dns.pihole.svc.cluster.local"
    webHost: ""            # e.g. "custom-web.pihole.svc.cluster.local"
    busyboxImage: "busybox:1.36.1"
*/ -}}
{{- $neb := .Values.nebulaSync | default (dict) -}}
{{- if $neb.enabled | default true -}}
{{- $fullname := include "pihole.fullname" . -}}
{{- $secretName := default (printf "%s-nebula-sync" $fullname) $neb.existingSecret -}}
{{- $wait := $neb.wait | default (dict) -}}
{{- $dnsEnabled := default true ($wait.waitForDNS) -}}
{{- $webEnabled := default false ($wait.waitForWeb) -}}
{{- $replicasEnabled := default true ($wait.waitForReplicas) -}}
{{- $dnsHost := default (printf "%s-dns.%s.svc.cluster.local" $fullname .Release.Namespace) ($wait.dnsHost) -}}
{{- $webHost := default (printf "%s-web-primary.%s.svc.cluster.local" $fullname .Release.Namespace) ($wait.webHost) -}}
{{- $busyboxImage := default "busybox:1.36.1" ($wait.busyboxImage) -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ printf "%s-nebula-sync" $fullname }}
  labels:
    app.kubernetes.io/name: nebula-sync
    app.kubernetes.io/part-of: {{ template "pihole.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
spec:
  replicas: {{ default 1 $neb.replicas }}
  selector:
    matchLabels:
      app.kubernetes.io/name: nebula-sync
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: nebula-sync
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      {{- with $neb.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $neb.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $neb.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      {{- if or $dnsEnabled (or $webEnabled $replicasEnabled) }}
      initContainers:
        {{- if $dnsEnabled }}
        - name: wait-for-pihole-dns
          image: {{ $busyboxImage | quote }}
          command:
            - sh
            - -c
            - >
              until nslookup example.com {{ $dnsHost }} >/dev/null 2>&1;
              do echo "waiting for DNS via {{ $dnsHost }} (UDP:53)..."; sleep 2; done;
              echo "DNS ready via {{ $dnsHost }}."
        {{- end }}

        {{- if $webEnabled }}
        - name: wait-for-pihole-web
          image: {{ $busyboxImage | quote }}
          command:
            - sh
            - -c
            - >
              until nc -z {{ $webHost }} 80;
              do echo "waiting for web at {{ $webHost }}:80 ..."; sleep 2; done;
              echo "Web ready at {{ $webHost }}:80."
        {{- end }}

        {{- if $replicasEnabled }}
        - name: wait-for-replicas
          image: {{ $busyboxImage | quote }}
          volumeMounts:
            - name: nebula-sync-secrets
              mountPath: /run/secrets
              readOnly: true
          command:
            - sh
            - -c
            - |
              set -eu
              REPLICAS_FILE="/run/secrets/replicas"
              if [ ! -s "$REPLICAS_FILE" ]; then
                echo "Replica list empty or missing ($REPLICAS_FILE). Skipping wait."
                exit 0
              fi

              # Iterate each non-empty line of form: http(s)://host[:port]|password
              while IFS= read -r line || [ -n "$line" ]; do
                # Trim whitespace
                line="$(echo "$line" | tr -d '[:space:]')"
                [ -z "$line" ] && continue
                echo "$line" | grep -q '|' || continue

                endpoint="${line%%|*}"               # left side before '|'
                # strip scheme and trailing slash
                endpoint="${endpoint#http://}"
                endpoint="${endpoint#https://}"
                endpoint="${endpoint%/}"

                host="${endpoint%%:*}"
                port="${endpoint##*:}"

                if [ "$host" = "$port" ]; then
                  # no port provided; default to 80
                  port=80
                fi

                # Wait for TCP reachability for each replica
                until nc -z "$host" "$port"; do
                  echo "waiting for replica $host:$port ..."
                  sleep 2
                done
                echo "replica $host:$port ready."
              done < "$REPLICAS_FILE"
        {{- end }}
      {{- end }}

      volumes:
        - name: nebula-sync-secrets
          secret:
            secretName: {{ $secretName }}
            optional: false

      containers:
        - name: nebula-sync
          image: {{ default "ghcr.io/lovelaze/nebula-sync:latest" $neb.image }}
          imagePullPolicy: {{ default "IfNotPresent" $neb.imagePullPolicy }}
          env:
            # REQUIRED by nebula-sync: files contain "http://host:port|password"
            - name: PRIMARY_FILE
              value: /run/secrets/primary
            - name: REPLICAS_FILE
              value: /run/secrets/replicas

            # Optional feature flags / schedule
            {{- if hasKey $neb "fullSync" }}
            - name: FULL_SYNC
              value: {{ $neb.fullSync | toString | quote }}
            {{- end }}
            {{- if hasKey $neb "runGravity" }}
            - name: RUN_GRAVITY
              value: {{ $neb.runGravity | toString | quote }}
            {{- end }}
            {{- if $neb.cron }}
            - name: CRON
              value: {{ $neb.cron | quote }}
            {{- end }}
            {{- if $neb.timezone }}
            - name: TZ
              value: {{ $neb.timezone | quote }}
            {{- end }}

            # HTTP client knobs
            {{- if hasKey $neb "clientSkipTLSVerify" }}
            - name: CLIENT_SKIP_TLS_VERIFICATION
              value: {{ $neb.clientSkipTLSVerify | toString | quote }}
            {{- end }}
            {{- if hasKey $neb "clientRetryDelaySeconds" }}
            - name: CLIENT_RETRY_DELAY_SECONDS
              value: {{ $neb.clientRetryDelaySeconds | toString | quote }}
            {{- end }}
            {{- if hasKey $neb "clientTimeoutSeconds" }}
            - name: CLIENT_TIMEOUT_SECONDS
              value: {{ $neb.clientTimeoutSeconds | toString | quote }}
            {{- end }}

          volumeMounts:
            - name: nebula-sync-secrets
              mountPath: /run/secrets
              readOnly: true

          resources:
            {{- toYaml (default (dict) $neb.resources) | nindent 12 }}

          {{- with $neb.livenessProbe }}
          livenessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with $neb.readinessProbe }}
          readinessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
{{- end }}
